package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.47

import (
	"context"
	"fmt"
	"time"

	"github.com/bclswl0827/openstation/drivers/dao/table"
	"github.com/bclswl0827/openstation/drivers/gnss"
	"github.com/bclswl0827/openstation/drivers/pan_tilt"
	"github.com/bclswl0827/openstation/drivers/tle"
	"github.com/bclswl0827/openstation/graph/model"
	"github.com/bclswl0827/openstation/utils/system"
	"gorm.io/gorm"
)

// SetPanTiltToAngle is the resolver for the SetPanTiltToAngle field.
func (r *mutationResolver) SetPanTiltToAngle(ctx context.Context, newPan float64, newTilt float64) (bool, error) {
	driver := pan_tilt.PanTiltDriver(&pan_tilt.PanTiltDriverImpl{})
	err := r.Dependency.Invoke(func(deps *pan_tilt.PanTiltDependency) error {
		sig := make(chan bool)
		err := driver.SetPan(deps, newPan, sig)
		if err != nil {
			return err
		}
		<-sig

		err = driver.SetTilt(deps, newTilt, sig)
		if err != nil {
			return err
		}
		<-sig

		return nil
	})
	if err != nil {
		return false, err
	}

	return true, nil
}

// SetPanTiltToNorth is the resolver for the SetPanTiltToNorth field.
func (r *mutationResolver) SetPanTiltToNorth(ctx context.Context) (bool, error) {
	panic(fmt.Errorf("not implemented: SetPanTiltToNorth - SetPanTiltToNorth"))
}

// SetAllTLEs is the resolver for the SetAllTLEs field.
func (r *mutationResolver) SetAllTLEs(ctx context.Context, tleData []string) (bool, error) {
	// Get current time from GNSS
	var currentTime time.Time
	err := r.Dependency.Invoke(func(deps *gnss.GnssDependency) error {
		t, err := deps.State.Time.GetTime()
		if err != nil {
			return err
		}
		currentTime = t
		return nil
	})
	if err != nil {
		return false, err
	}

	// Parse and append each TLE record to array
	var (
		tleModel   table.SatelliteTLE
		tleRecords []table.SatelliteTLE
	)
	for _, tleInput := range tleData {
		var (
			inputTLE       tle.TLE
			mockObserver   tle.Observer
			inputSatellite tle.Satellite
		)
		err := inputTLE.Load(tleInput)
		if err != nil {
			return false, err
		}

		mockObserver.Latitude = -1
		mockObserver.Longitude = -1
		mockObserver.Time = currentTime
		err = inputSatellite.Parse(&inputTLE, &mockObserver)
		if err != nil {
			return false, err
		}

		tleRecords = append(tleRecords, table.SatelliteTLE{
			ID:            inputTLE.ID,
			Name:          inputTLE.Name,
			Line_1:        inputTLE.Line_1,
			Line_2:        inputTLE.Line_2,
			LastUpdate:    currentTime.UnixMilli(),
			EpochTime:     inputSatellite.Epoch.UnixMilli(),
			Geostationary: inputSatellite.Geostationary,
		})
	}

	// Insert TLE records to database
	err = r.Database.Transaction(func(tx *gorm.DB) error {
		// Clear all TLE records before adding new ones
		err := tx.
			Table(tleModel.GetName()).
			Select("*").
			Where("id = id").
			Delete(tleModel).
			Error
		if err != nil {
			return err
		}
		// Insert new TLE records
		return tx.
			Table(tleModel.GetName()).
			Create(&tleRecords).
			Error
	})
	if err != nil {
		return false, err
	}

	return true, nil
}

// DeleteTLEByID is the resolver for the DeleteTLEById field.
func (r *mutationResolver) DeleteTLEByID(ctx context.Context, id int) (bool, error) {
	var tleModel table.SatelliteTLE
	err := r.Database.
		Table(tleModel.GetName()).
		Where("id = ?", id).
		Delete(tleModel).
		Error
	if err != nil {
		return false, err
	}

	return true, nil
}

// UpdateTLEByID is the resolver for the UpdateTLEById field.
func (r *mutationResolver) UpdateTLEByID(ctx context.Context, id int, tleData string) (bool, error) {
	var (
		tleModel  table.SatelliteTLE
		tleRecord table.SatelliteTLE
	)

	// Check TLE record existence
	err := r.Database.
		Table(tleModel.GetName()).
		Where("id = ?", id).
		First(&tleRecord).
		Error
	if err != nil {
		return false, err
	}
	if len(tleRecord.Line_1) == 0 || len(tleRecord.Line_2) == 0 {
		return false, fmt.Errorf("no matching TLE record found")
	}

	// Load input TLE data, compare IDs
	var (
		inputTLE       tle.TLE
		mockObserver   tle.Observer
		inputSatellite tle.Satellite
	)
	err = inputTLE.Load(tleData)
	if err != nil {
		return false, err
	} else if inputTLE.ID != int64(id) {
		return false, fmt.Errorf("input TLE ID mismatch the record ID")
	}

	// Get current time from GNSS
	var currentTime time.Time
	err = r.Dependency.Invoke(func(deps *gnss.GnssDependency) error {
		t, err := deps.State.Time.GetTime()
		if err != nil {
			return err
		}
		currentTime = t
		return nil
	})
	if err != nil {
		return false, err
	}

	// Parse input TLE data
	mockObserver.Time = currentTime
	err = inputSatellite.Parse(&inputTLE, &mockObserver)
	if err != nil {
		return false, err
	}

	tleRecord.Name = inputTLE.Name
	tleRecord.Line_1 = inputTLE.Line_1
	tleRecord.Line_2 = inputTLE.Line_2
	tleRecord.EpochTime = inputSatellite.Epoch.UnixMilli()
	tleRecord.LastUpdate = currentTime.UnixMilli()
	tleRecord.Geostationary = inputSatellite.Geostationary

	// Update TLE record
	err = r.Database.
		Table(tleModel.GetName()).
		Where("id = ?", id).
		Updates(tleRecord).
		Error
	if err != nil {
		return false, err
	}

	return true, nil
}

// RebootSystem is the resolver for the RebootSystem field.
func (r *mutationResolver) RebootSystem(ctx context.Context) (bool, error) {
	// Reboot system after 3 seconds
	go func() {
		time.Sleep(3 * time.Second)
		system.Reboot()
	}()

	return true, nil
}

// PurgeTaskQueue is the resolver for the PurgeTaskQueue field.
func (r *mutationResolver) PurgeTaskQueue(ctx context.Context) (bool, error) {
	var taskModel table.TaskQueue
	err := r.Database.Table(taskModel.GetName()).
		Select("*").
		Where("id = id").
		Delete(&taskModel).
		Error
	if err != nil {
		return false, err
	}

	return true, nil
}

// PurgeTLERecords is the resolver for the PurgeTLERecords field.
func (r *mutationResolver) PurgeTLERecords(ctx context.Context) (bool, error) {
	var tleModel table.SatelliteTLE
	err := r.Database.Table(tleModel.GetName()).
		Select("*").
		Where("id = id").
		Delete(&tleModel).
		Error
	if err != nil {
		return false, err
	}

	return true, nil
}

// PurgeForecastRecords is the resolver for the PurgeForecastRecords field.
func (r *mutationResolver) PurgeForecastRecords(ctx context.Context) (bool, error) {
	var forecastModel table.TransitForcast

	// Clean all forecast records
	err := r.Database.Transaction(func(tx *gorm.DB) error {
		err := tx.
			Table(forecastModel.GetName()).
			Select("*").
			Where("id = id").
			Delete(forecastModel).
			Error
		if err != nil {
			return err
		}
		return nil
	})
	if err != nil {
		return false, err
	}

	return true, nil
}

// GetStation is the resolver for the GetStation field.
func (r *queryResolver) GetStation(ctx context.Context) (*model.Station, error) {
	// Get satellite count from database
	var (
		tleModel       table.SatelliteTLE
		satelliteCount int64
	)
	err := r.Database.
		Table(tleModel.GetName()).
		Count(&satelliteCount).
		Error
	if err != nil {
		return nil, err
	}

	// Get coordinates from GNSS
	var (
		latitude  float64
		longitude float64
	)
	err = r.Dependency.Invoke(func(deps *gnss.GnssDependency) error {
		latitude, longitude = deps.State.Latitude, deps.State.Longitude
		return nil
	})
	if err != nil {
		return nil, err
	}

	// TODO: Add more fields to the Station model
	// 	  PendingTasks  int    `json:"pendingTasks"`
	// 	  TaskCountdown int    `json:"taskCountdown"`

	return &model.Station{
		Latitude:   latitude,
		Longitude:  longitude,
		Satellites: int(satelliteCount),
		Name:       r.Config.Station.Name,
		Remark:     r.Config.Station.Remark,
		Location:   r.Config.Station.Location,
	}, nil
}

// GetPanTilt is the resolver for the GetPanTilt field.
func (r *queryResolver) GetPanTilt(ctx context.Context) (*model.PanTilt, error) {
	return &model.PanTilt{
		// IsBusy:       r.State.PanTilt.IsBusy,
		// HasFindNorth: r.State.PanTilt.HasFindNorth,
	}, nil
}

// GetSystem is the resolver for the GetSystem field.
func (r *queryResolver) GetSystem(ctx context.Context) (*model.System, error) {
	uptime, err := system.GetUptime()
	if err != nil {
		return nil, err
	}

	cpuUsage, err := system.GetCPUUsage()
	if err != nil {
		return nil, err
	}

	memUsage, err := system.GetMemUsage()
	if err != nil {
		return nil, err
	}

	diskUsage, err := system.GetDiskUsage()
	if err != nil {
		return nil, err
	}

	release, err := system.GetRelease()
	if err != nil {
		return nil, err
	}

	arch, err := system.GetArch()
	if err != nil {
		return nil, err
	}

	hostname, err := system.GetHostname()
	if err != nil {
		return nil, err
	}

	ipAddrs, err := system.GetIPv4Addrs()
	if err != nil {
		return nil, err
	}

	return &model.System{
		Uptime:    int(uptime),
		CPUUsage:  cpuUsage,
		MemUsage:  memUsage,
		DiskUsage: diskUsage,
		Release:   release,
		Arch:      arch,
		Hostname:  hostname,
		IP:        ipAddrs,
	}, nil
}

// GetAllTLEId is the resolver for the GetAllTLEId field.
func (r *queryResolver) GetAllTLEId(ctx context.Context) ([]*int, error) {
	var tleId []*int
	var tleModel table.SatelliteTLE
	err := r.Database.
		Table(tleModel.GetName()).
		Pluck("id", &tleId).
		Error
	if err != nil {
		return nil, err
	}

	return tleId, nil
}

// GetTLEByID is the resolver for the GetTLEById field.
func (r *queryResolver) GetTLEByID(ctx context.Context, id int) (*model.TLEData, error) {
	var (
		tleModel  table.SatelliteTLE
		tleRecord table.SatelliteTLE
	)

	// Check TLE record existence
	err := r.Database.
		Table(tleModel.GetName()).
		Where("id = ?", id).
		First(&tleRecord).
		Error
	if err != nil {
		return nil, err
	}
	if len(tleRecord.Line_1) == 0 || len(tleRecord.Line_2) == 0 {
		return nil, fmt.Errorf("no  matching TLE record found")
	}

	// Get current time from GNSS
	var currentTime time.Time
	err = r.Dependency.Invoke(func(deps *gnss.GnssDependency) error {
		t, err := deps.State.Time.GetTime()
		if err != nil {
			return err
		}
		currentTime = t
		return nil
	})
	if err != nil {
		return nil, err
	}

	return &model.TLEData{
		ID:         int(tleRecord.ID),
		Name:       tleRecord.Name,
		Line1:      tleRecord.Line_1,
		Line2:      tleRecord.Line_2,
		LastUpdate: int(tleRecord.LastUpdate),
		Expired: time.UnixMilli(tleRecord.EpochTime).UTC().
			Sub(currentTime).Hours() > tle.EXPIRATION_DAYS.Hours(),
	}, nil
}

// Mutation returns MutationResolver implementation.
func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

// Query returns QueryResolver implementation.
func (r *Resolver) Query() QueryResolver { return &queryResolver{r} }

type mutationResolver struct{ *Resolver }
type queryResolver struct{ *Resolver }
